{% extends "admin/base.html" %}

{% block title %}Submissions{% endblock %}
{% block breadcrumb %}Submissions{% endblock %}
{% block page_title %}Submissions Log{% endblock %}

{% block header_actions %}
  <span class="badge badge-muted">{{ submissions | length }} results</span>
  <span class="badge badge-info">Read-Only</span>
{% endblock %}

{% block content %}

<!-- Filters -->
<div class="card">
  <div class="card-body">
    <form method="get" action="/admin/submissions" style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end;">
      <div class="form-group" style="flex:1;min-width:140px;">
        <label for="f-status">Status</label>
        <select id="f-status" name="status">
          <option value="">All Statuses</option>
          <option value="passed"{% if filter_status == 'passed' %} selected{% endif %}>Passed</option>
          <option value="failed"{% if filter_status == 'failed' %} selected{% endif %}>Failed</option>
          <option value="syntax_error"{% if filter_status == 'syntax_error' %} selected{% endif %}>Syntax Error</option>
        </select>
      </div>
      <div class="form-group" style="flex:1;min-width:140px;">
        <label for="f-user">User</label>
        <select id="f-user" name="user_id">
          <option value="">All Users</option>
          {% for u in users %}
            <option value="{{ u.id }}"{% if filter_user_id == u.id %} selected{% endif %}>{{ u.username }}</option>
          {% endfor %}
        </select>
      </div>
      <div class="form-group" style="flex:1;min-width:140px;">
        <label for="f-level">Level</label>
        <select id="f-level" name="level_id">
          <option value="">All Levels</option>
          {% for lvl in levels %}
            <option value="{{ lvl.id }}"{% if filter_level_id == lvl.id %} selected{% endif %}>{{ lvl.title }}</option>
          {% endfor %}
        </select>
      </div>
      <button type="submit" class="btn btn-primary btn-sm">Filter</button>
      <a href="/admin/submissions" class="btn btn-ghost btn-sm">Reset</a>
    </form>
  </div>
</div>

<!-- Table -->
<div class="card">
  <div class="card-head">
    <div class="card-title">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
      All Submissions
    </div>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>User</th>
          <th>Level</th>
          <th>Status</th>
          <th>Preview</th>
          <th>Timestamp</th>
          <th>Playback</th>
        </tr>
      </thead>
      <tbody>
        {% if submissions %}
          {% for sub in submissions %}
          <tr>
            <td class="mono">{{ sub.id }}</td>
            <td>
              <div style="display:flex;align-items:center;gap:8px;">
                <div style="width:26px;height:26px;background:var(--brand-soft);border:1px solid var(--brand-border);border-radius:6px;display:flex;align-items:center;justify-content:center;font-size:0.68rem;font-weight:800;color:var(--brand-light);font-family:var(--font-mono);flex-shrink:0;">
                  {{ sub.user.username[0].upper() if sub.user and sub.user.username else '?' }}
                </div>
                <a href="/admin/users/{{ sub.user_id }}" style="font-weight:600;font-size:0.84rem;color:var(--brand-light);">
                  {{ sub.user.username if sub.user else 'User #' ~ sub.user_id }}
                </a>
              </div>
            </td>
            <td>
              {% if sub.level %}
                <a href="/admin/levels/{{ sub.level.id }}/edit" style="font-size:0.83rem;font-weight:600;color:var(--text-1);">{{ sub.level.title }}</a>
              {% else %}
                <span class="badge badge-muted">Level #{{ sub.level_id }}</span>
              {% endif %}
            </td>
            <td>
              {% set s = (sub.status or '') | lower %}
              {% if s == 'passed' %}
                <span class="badge badge-success">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"/></svg>
                  Passed
                </span>
              {% elif s == 'failed' %}
                <span class="badge badge-danger">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                  Failed
                </span>
              {% elif 'syntax' in s or 'error' in s %}
                <span class="badge badge-warning">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.48 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3"/><line x1="12" y1="9" x2="12" y2="13"/><line x1="12" y1="17" x2="12.01" y2="17"/></svg>
                  Syntax Error
                </span>
              {% else %}
                <span class="badge badge-muted">{{ sub.status or 'Unknown' }}</span>
              {% endif %}
            </td>
            <td style="max-width:200px;">
              <code style="font-size:0.71rem;color:var(--text-3);background:var(--bg-surface);padding:3px 7px;border-radius:4px;display:block;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;font-family:var(--font-mono);">
                {{ sub.submitted_code[:60] ~ '…' if sub.submitted_code and sub.submitted_code|length > 60 else (sub.submitted_code or '—') }}
              </code>
            </td>
            <td class="mono" style="font-size:0.75rem;color:var(--text-3);white-space:nowrap;">
              {{ sub.timestamp.strftime('%d %b %Y, %H:%M') if sub.timestamp else '—' }}
            </td>
            <td>
              <a href="/admin/submissions/{{ sub.id }}/playback" class="btn btn-ghost btn-sm">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="16 18 22 12 16 6"/><polyline points="8 6 2 12 8 18"/></svg>
                View Code
              </a>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr class="empty-row">
            <td colspan="7">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
              No submissions match the current filter.
              <p><a href="/admin/submissions">Clear filters</a> to see all submissions.</p>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>
{% endblock %}
