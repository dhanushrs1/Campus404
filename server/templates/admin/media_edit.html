{% extends "admin/base.html" %}

{% block title %}Edit Media{% endblock %}
{% block breadcrumb %}Media · Edit{% endblock %}
{% block page_title %}Edit Media{% endblock %}

{% block head %}
<style>
.media-edit-layout {
  display: grid;
  grid-template-columns: 1fr 380px;
  gap: 24px;
  align-items: start;
}
@media (max-width: 860px) {
  .media-edit-layout { grid-template-columns: 1fr; }
}

/* Left — preview */
.media-preview-card {
  background: var(--surface-2);
  border: 1px solid var(--border-sm);
  border-radius: 16px;
  overflow: hidden;
  position: sticky;
  top: 24px;
}
.media-preview-img {
  width: 100%;
  max-height: 460px;
  object-fit: contain;
  display: block;
  background: var(--surface-3);
  padding: 12px;
}
.media-preview-meta {
  padding: 16px 20px;
  border-top: 1px solid var(--border-sm);
  display: flex; flex-direction: column; gap: 8px;
}
.meta-row {
  display: flex; justify-content: space-between; align-items: center;
  font-size: .78rem;
}
.meta-row dt { color: var(--text-muted); margin: 0; }
.meta-row dd { color: var(--text-primary); font-weight: 500; margin: 0; text-align: right; max-width: 55%; word-break: break-all; }
.url-copy-wrap {
  display: flex; gap: 6px; align-items: center; margin-top: 4px;
}
.url-copy-input {
  flex: 1; font-size: .72rem; font-family: var(--font-mono);
  padding: 5px 8px;
  background: var(--surface-3); border: 1px solid var(--border-sm);
  border-radius: 6px; color: var(--text-secondary);
}
.url-copy-btn {
  padding: 5px 10px; font-size: .72rem; font-weight: 600;
  background: var(--surface-3); border: 1px solid var(--border-sm);
  border-radius: 6px; color: var(--text-primary); cursor: pointer;
  font-family: inherit; transition: background .15s;
  white-space: nowrap;
}
.url-copy-btn:hover { background: var(--border-md); }

/* Right — form */
.media-form-card { display: flex; flex-direction: column; gap: 0; }
.form-group      { margin-bottom: 18px; }
.form-label      { display: block; font-size: .8rem; font-weight: 600; color: var(--text-secondary); margin-bottom: 6px; }
.form-label span { font-size: .72rem; font-weight: 400; color: var(--text-muted); margin-left: 4px; }
.form-control {
  width: 100%; box-sizing: border-box;
  padding: 9px 12px;
  background: var(--surface-2); border: 1px solid var(--border-md);
  border-radius: 8px; color: var(--text-primary);
  font-size: .85rem; font-family: inherit;
  transition: border-color .15s, box-shadow .15s;
}
.form-control:focus {
  outline: none; border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(99,102,241,.15);
}
textarea.form-control { resize: vertical; min-height: 90px; line-height: 1.5; }
.form-hint { font-size: .72rem; color: var(--text-muted); margin: 4px 0 0; }

.form-actions {
  display: flex; gap: 10px; align-items: center;
  padding-top: 8px; border-top: 1px solid var(--border-sm); margin-top: 4px;
}
.btn-danger-soft {
  background: rgba(239, 68, 68, 0.12);
  color: #ef4444;
  border: 1px solid rgba(239, 68, 68, 0.3);
  display: inline-flex; align-items: center; gap: 6px;
  font-size: .8rem; font-weight: 600; font-family: inherit;
  border-radius: 8px; padding: 7px 14px; cursor: pointer;
  transition: background .15s, border-color .15s;
}
.btn-danger-soft:hover {
  background: rgba(239, 68, 68, 0.22);
  border-color: rgba(239, 68, 68, 0.5);
}
.btn-danger-soft svg { width: 14px; height: 14px; stroke-width: 2.5; }
</style>
{% endblock %}

{% block header_actions %}
  <a href="/admin/media" class="btn btn-ghost">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
         stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
      <polyline points="15 18 9 12 15 6"/>
    </svg>
    Back to Library
  </a>
{% endblock %}

{% block content %}
<div class="media-edit-layout">

  <!-- Left — image preview + file metadata -->
  <div class="media-preview-card">
    <img class="media-preview-img"
         src="{{ item.file_path }}"
         alt="{{ item.alt_text or item.original_name }}">
    <dl class="media-preview-meta">
      <div class="meta-row">
        <dt>Original name</dt>
        <dd>{{ item.original_name }}</dd>
      </div>
      <div class="meta-row">
        <dt>File size</dt>
        <dd>{{ fmt_bytes(item.file_size) }}</dd>
      </div>
      {% set dims = media_dim(item) %}
      {% if dims %}
      <div class="meta-row">
        <dt>Dimensions</dt>
        <dd>{{ dims }}</dd>
      </div>
      {% endif %}
      <div class="meta-row">
        <dt>Type</dt>
        <dd>{{ item.mime_type }}</dd>
      </div>
      <div class="meta-row">
        <dt>Uploaded</dt>
        <dd>{{ item.uploaded_at.strftime('%d %b %Y, %H:%M') if item.uploaded_at else '—' }}</dd>
      </div>
      <div style="margin-top:8px;">
        <dt class="form-label" style="margin-bottom:4px;">File URL</dt>
        <div class="url-copy-wrap">
          <input class="url-copy-input" id="file-url-input"
                 value="{{ item.file_path }}"
                 readonly>
          <button class="url-copy-btn" onclick="copyUrl()">Copy</button>
        </div>
      </div>
      <div style="margin-top:8px;">
        <a href="{{ item.file_path }}" target="_blank"
           style="font-size:.75rem;color:var(--brand-light);text-decoration:none;">
          Open in new tab ↗
        </a>
      </div>
    </dl>
  </div>

  <!-- Right — edit form -->
  <div>
    <div class="card media-form-card">
      <div class="card-head">
        <div class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
            <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
          </svg>
          Edit Media Details
        </div>
      </div>
      <div style="padding:24px;">
        <form method="post" action="/admin/media/{{ item.id }}/update">

          <div class="form-group">
            <label class="form-label" for="title">
              Title <span>— shown in the media grid</span>
            </label>
            <input class="form-control" id="title" name="title"
                   type="text" placeholder="e.g. Campus Banner Image"
                   value="{{ item.title or '' }}">
          </div>

          <div class="form-group">
            <label class="form-label" for="alt_text">
              Alt Text <span>— describes the image for accessibility &amp; SEO</span>
            </label>
            <input class="form-control" id="alt_text" name="alt_text"
                   type="text" placeholder="e.g. Students coding in a lab"
                   value="{{ item.alt_text or '' }}">
            <p class="form-hint">Used in the HTML <code>alt=""</code> attribute when embedding this image.</p>
          </div>

          <div class="form-group">
            <label class="form-label" for="caption">
              Caption <span>— optional short note displayed below the image</span>
            </label>
            <textarea class="form-control" id="caption" name="caption"
                      placeholder="e.g. Photo taken during the 2025 hackathon.">{{ item.caption or '' }}</textarea>
          </div>

          <div class="form-group">
            <label class="form-label" for="description">
              Description <span>— longer internal note (not shown to students)</span>
            </label>
            <textarea class="form-control" id="description" name="description"
                      style="min-height:120px;"
                      placeholder="Internal notes about this image…">{{ item.description or '' }}</textarea>
          </div>

          <div class="form-actions">
            <button type="submit" class="btn btn-primary">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                   stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="20 6 9 17 4 12"/>
              </svg>
              Save Changes
            </button>
            <a href="/admin/media" class="btn btn-ghost">Cancel</a>

            <!-- Delete button links to separate form below -->
            <button type="button" class="btn btn-danger-soft btn-sm"
                    style="margin-left:auto;"
                    onclick="if(confirm('Permanently delete this file? This cannot be undone.')) document.getElementById('delete-form-{{ item.id }}').submit()">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
                   stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
                <polyline points="3 6 5 6 21 6"/>
                <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
              </svg>
              Delete File
            </button>
          </div>

        </form>

        <!-- Delete form must live OUTSIDE the save form (nested forms are invalid HTML) -->
        <form id="delete-form-{{ item.id }}"
              method="post"
              action="/admin/media/{{ item.id }}/delete"
              onsubmit="return confirm('Permanently delete this file? This cannot be undone.')"></form>
      </div>
    </div>

    {% if msg %}
    <div class="flash flash-{{ msg_type | default('success') }}" style="margin-top:16px;">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        {% if msg_type == 'error' %}
        <circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/>
        {% else %}
        <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
        {% endif %}
      </svg>
      {{ msg }}
    </div>
    {% endif %}
  </div>

</div>
{% endblock %}

{% block scripts %}
<script>
// Set the full absolute URL now that we know the browser origin
(function() {
  var input = document.getElementById('file-url-input');
  if (input) {
    input.value = window.location.origin + input.value;
  }
})();

function copyUrl() {
  const input = document.getElementById('file-url-input');
  input.select();
  document.execCommand('copy');
  const btn = input.nextElementSibling;
  btn.textContent = 'Copied!';
  setTimeout(() => btn.textContent = 'Copy', 1800);
}
</script>
{% endblock %}
