{% extends "admin/base.html" %}

{% block title %}User — {{ user.username }}{% endblock %}
{% block breadcrumb %}Users{% endblock %}
{% block page_title %}{{ user.username or 'Unknown User' }}{% endblock %}

{% block header_actions %}
  <a href="/admin/users" class="btn btn-ghost btn-sm">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polyline points="15 18 9 12 15 6"/></svg>
    Back to Users
  </a>
{% endblock %}

{% block content %}

<!-- Profile Header -->
<div class="card">
  <div class="card-body" style="display:flex;align-items:center;gap:20px;flex-wrap:wrap;">
    <div style="width:56px;height:56px;background:var(--brand-soft);border:1px solid var(--brand-border);border-radius:var(--radius-lg);display:flex;align-items:center;justify-content:center;font-size:1.4rem;font-weight:800;color:var(--brand-light);font-family:var(--font-mono);flex-shrink:0;">
      {{ user.username[0].upper() if user.username else '?' }}
    </div>
    <div style="flex:1;min-width:0;">
      <div style="font-size:1.1rem;font-weight:800;color:var(--text-1);">{{ user.username or '—' }}</div>
      <div style="font-size:0.82rem;color:var(--text-3);margin-top:2px;">{{ user.email or 'No email on record' }}</div>
      <div style="display:flex;gap:8px;margin-top:8px;flex-wrap:wrap;">
        {% if user.is_admin %}<span class="badge badge-brand">Admin</span>{% else %}<span class="badge badge-muted">User</span>{% endif %}
        {% if user.is_banned %}<span class="badge badge-danger">Banned</span>{% else %}<span class="badge badge-success">Active</span>{% endif %}
      </div>
    </div>
    <div style="display:flex;flex-direction:column;align-items:flex-end;gap:4px;flex-shrink:0;">
      <div style="font-family:var(--font-mono);font-size:1.6rem;font-weight:800;color:var(--warning);">⚡ {{ user.total_xp or 0 }}</div>
      <div style="font-size:0.7rem;text-transform:uppercase;letter-spacing:0.08em;color:var(--text-3);">Total XP</div>
    </div>
  </div>
</div>

<!-- Info + Quick Actions Grid -->
<div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;" class="responsive-stack">

  <!-- Detail Info -->
  <div class="card">
    <div class="card-head">
      <div class="card-title">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="10"/><line x1="12" y1="8" x2="12" y2="12"/><line x1="12" y1="16" x2="12.01" y2="16"/></svg>
        Account Info
      </div>
    </div>
    <div class="card-body form-grid" style="gap:14px;">
      <div>
        <div style="font-size:0.67rem;font-weight:700;letter-spacing:0.09em;text-transform:uppercase;color:var(--text-3);">User ID</div>
        <div style="font-family:var(--font-mono);font-size:0.88rem;color:var(--text-1);margin-top:3px;">#{{ user.id }}</div>
      </div>
      <div>
        <div style="font-size:0.67rem;font-weight:700;letter-spacing:0.09em;text-transform:uppercase;color:var(--text-3);">Email</div>
        <div style="font-size:0.88rem;color:var(--text-1);margin-top:3px;">{{ user.email or '—' }}</div>
      </div>
      <div>
        <div style="font-size:0.67rem;font-weight:700;letter-spacing:0.09em;text-transform:uppercase;color:var(--text-3);">Joined</div>
        <div style="font-family:var(--font-mono);font-size:0.88rem;color:var(--text-1);margin-top:3px;">
          {{ user.created_at.strftime('%d %b %Y, %H:%M') if user.created_at else '—' }}
        </div>
      </div>
      {% if current_level %}
      <div>
        <div style="font-size:0.67rem;font-weight:700;letter-spacing:0.09em;text-transform:uppercase;color:var(--text-3);">Currently Stuck On</div>
        <div style="font-size:0.88rem;color:var(--warning);margin-top:3px;font-weight:600;">⚙ {{ current_level.title }}</div>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Controls -->
  <div style="display:flex;flex-direction:column;gap:16px;">

    <!-- XP Adjust -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M13 2L3 14h9l-1 8 10-12h-9l1-8z"/></svg>
          Adjust XP
        </div>
      </div>
      <div class="card-body">
        <form method="post" action="/admin/users/{{ user.id }}/adjust-xp" style="display:flex;gap:10px;align-items:flex-end;">
          <div class="form-group" style="flex:1;">
            <label for="xp_delta">XP Delta (positive or negative)</label>
            <input id="xp_delta" type="number" name="xp_delta" value="0" placeholder="e.g. 50 or -100">
          </div>
          <button type="submit" class="btn btn-primary">Apply</button>
        </form>
      </div>
    </div>

    <!-- Quick Toggles -->
    <div class="card">
      <div class="card-head">
        <div class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
          Access Controls
        </div>
      </div>
      <div class="card-body" style="display:flex;gap:10px;flex-wrap:wrap;">
        <form method="post" action="/admin/users/{{ user.id }}/toggle-admin">
          <button type="submit" class="btn {% if user.is_admin %}btn-warning-soft{% else %}btn-ghost{% endif %} btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10z"/></svg>
            {{ 'Remove Admin' if user.is_admin else 'Grant Admin' }}
          </button>
        </form>
        <form method="post" action="/admin/users/{{ user.id }}/toggle-ban">
          <button type="submit" class="btn {% if user.is_banned %}btn-success-soft{% else %}btn-danger-soft{% endif %} btn-sm">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round">
              {% if user.is_banned %}<path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"/><polyline points="22 4 12 14.01 9 11.01"/>
              {% else %}<circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/>{% endif %}
            </svg>
            {{ 'Unban User' if user.is_banned else 'Ban User' }}
          </button>
        </form>
      </div>
    </div>

  </div>
</div>

<!-- Progress Table -->
<div class="card">
  <div class="card-head">
    <div class="card-title">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="22 12 18 12 15 21 9 3 6 12 2 12"/></svg>
      Level Progress
    </div>
    <span class="badge badge-muted">{{ progress | length }} entries</span>
  </div>
  <div class="table-wrap">
    <table>
      <thead>
        <tr>
          <th>Level</th>
          <th>Status</th>
          <th>Failed Attempts</th>
        </tr>
      </thead>
      <tbody>
        {% if progress %}
          {% for p in progress | sort(attribute='level.order_number') %}
          <tr>
            <td>
              {% if p.level %}
                <a href="/admin/levels/{{ p.level.id }}/edit" style="font-weight:600;color:var(--brand-light);">{{ p.level.title }}</a>
              {% else %}
                <span class="muted">Level #{{ p.level_id }}</span>
              {% endif %}
            </td>
            <td>
              {% if p.is_completed %}
                <span class="badge badge-success">✓ Completed</span>
              {% else %}
                <span class="badge badge-warning">⏳ In Progress</span>
              {% endif %}
            </td>
            <td class="mono">{{ p.failed_attempts }}</td>
          </tr>
          {% endfor %}
        {% else %}
          <tr class="empty-row">
            <td colspan="3">
              <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><polygon points="12 2 2 7 12 12 22 7 12 2"/><polyline points="2 17 12 22 22 17"/><polyline points="2 12 12 17 22 12"/></svg>
              No progress recorded yet.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

{% endblock %}
