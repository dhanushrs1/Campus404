{% extends "admin/base.html" %}

{% block title %}Media Library{% endblock %}
{% block breadcrumb %}Media{% endblock %}
{% block page_title %}Media Library{% endblock %}

{% block head %}
<style>
/* ── Upload Drop-zone ───────────────────────────────────────────── */
.dropzone-wrap {
  border: 2px dashed var(--border-md);
  border-radius: 16px;
  padding: 48px 24px;
  text-align: center;
  background: var(--surface-2);
  cursor: pointer;
  transition: border-color .2s, background .2s;
  position: relative;
  margin-bottom: 28px;
}
.dropzone-wrap.drag-over {
  border-color: var(--brand);
  background: rgba(99,102,241,.06);
}
.dropzone-wrap input[type="file"] {
  position: absolute;
  inset: 0;
  opacity: 0;
  cursor: pointer;
  width: 100%;
  height: 100%;
}
.dz-icon {
  width: 48px; height: 48px;
  margin: 0 auto 16px;
  color: var(--brand-light);
  opacity: .7;
}
.dz-title { font-size: 1rem; font-weight: 600; color: var(--text-primary); margin: 0 0 6px; }
.dz-sub   { font-size: .82rem; color: var(--text-muted); margin: 0; }
.dz-progress-list { list-style: none; padding: 0; margin: 16px 0 0; display: flex; flex-direction: column; gap: 8px; }
.dz-prog-item { display: flex; align-items: center; gap: 10px; font-size: .8rem; color: var(--text-secondary); }
.dz-prog-bar-wrap { flex: 1; height: 4px; background: var(--border-md); border-radius: 4px; overflow: hidden; }
.dz-prog-bar { height: 100%; background: var(--brand); width: 0; transition: width .3s; border-radius: 4px; }

/* ── Toolbar ────────────────────────────────────────────────────── */
.media-toolbar {
  display: flex; align-items: center; gap: 12px; margin-bottom: 20px; flex-wrap: wrap;
}
.media-toolbar .search-wrap {
  flex: 1; min-width: 200px; max-width: 320px;
  position: relative;
}
.media-toolbar .search-wrap svg {
  position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
  width: 15px; height: 15px; color: var(--text-muted); pointer-events: none;
}
.media-toolbar .search-input {
  width: 100%; padding: 7px 12px 7px 34px;
  border: 1px solid var(--border-md); border-radius: 8px;
  background: var(--surface-2); color: var(--text-primary);
  font-size: .85rem; font-family: inherit;
  transition: border-color .15s, box-shadow .15s;
}
.media-toolbar .search-input:focus {
  outline: none; border-color: var(--brand);
  box-shadow: 0 0 0 3px rgba(99,102,241,.15);
}
.media-count { margin-left: auto; font-size: .8rem; color: var(--text-muted); white-space: nowrap; }

/* ── Media Grid ─────────────────────────────────────────────────── */
.media-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 16px;
}
.media-card {
  border-radius: 12px;
  background: var(--surface-2);
  border: 1px solid var(--border-sm);
  overflow: hidden;
  position: relative;
  transition: box-shadow .2s, transform .2s, border-color .2s;
}
.media-card:hover {
  box-shadow: 0 8px 30px rgba(0,0,0,.25);
  transform: translateY(-2px);
  border-color: var(--border-md);
}
.media-thumb {
  width: 100%;
  aspect-ratio: 1 / 1;
  object-fit: cover;
  display: block;
  background: var(--surface-3);
}
.media-card-body {
  padding: 10px 12px;
}
.media-card-name {
  font-size: .78rem;
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  margin: 0 0 4px;
}
.media-card-meta {
  font-size: .72rem;
  color: var(--text-muted);
  margin: 0;
}
/* Hover overlay */
.media-card-overlay {
  position: absolute;
  inset: 0;
  background: linear-gradient(to top, rgba(0,0,0,.75) 0%, rgba(0,0,0,0) 60%);
  opacity: 0;
  transition: opacity .2s;
  display: flex;
  align-items: flex-end;
  justify-content: center;
  gap: 8px;
  padding: 12px;
}
.media-card:hover .media-card-overlay { opacity: 1; }
.media-card-overlay a,
.media-card-overlay button {
  display: inline-flex; align-items: center; gap: 4px;
  font-size: .73rem; font-weight: 600;
  border-radius: 6px; padding: 5px 10px;
  cursor: pointer; border: none;
  font-family: inherit;
  white-space: nowrap;
  transition: filter .15s;
}
.media-card-overlay a { background: var(--brand); color: #fff; text-decoration: none; }
.media-card-overlay button { background: rgba(239,68,68,.85); color: #fff; }
.media-card-overlay a:hover, .media-card-overlay button:hover { filter: brightness(1.15); }
.media-card-overlay svg { width: 12px; height: 12px; }

/* ── Empty State ────────────────────────────────────────────────── */
.media-empty {
  text-align: center;
  padding: 60px 24px;
  color: var(--text-muted);
}
.media-empty svg {
  width: 56px; height: 56px;
  margin: 0 auto 16px; display: block;
  opacity: .35;
}
.media-empty p { margin: 0; font-size: .9rem; }
</style>
{% endblock %}

{% block header_actions %}
  <label class="btn btn-primary" style="cursor:pointer;">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
    Upload Files
    <input type="file" id="header-upload" multiple accept="image/*" style="display:none;">
  </label>
{% endblock %}

{% block content %}

<!-- ── Drop-zone ──────────────────────────────────────────────────── -->
<div class="dropzone-wrap" id="dropzone">
  <input type="file" id="dz-input" multiple accept="image/*">

  <svg class="dz-icon" xmlns="http://www.w3.org/2000/svg" fill="none"
       viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.4"
       stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
    <circle cx="8.5" cy="8.5" r="1.5"/>
    <polyline points="21 15 16 10 5 21"/>
  </svg>

  <p class="dz-title">Drop images here, or click to browse</p>
  <p class="dz-sub">Supported: JPG, PNG, GIF, WebP, SVG, BMP — multiple files allowed</p>
  <ul class="dz-progress-list" id="dz-progress-list"></ul>
</div>

<!-- ── Toolbar ───────────────────────────────────────────────────── -->
<div class="media-toolbar">
  <form method="get" action="/admin/media" style="display:contents;">
    <div class="search-wrap">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
           stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
        <circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/>
      </svg>
      <input class="search-input" name="q" value="{{ q }}" placeholder="Search by title or filename…">
    </div>
    <button type="submit" class="btn btn-secondary btn-sm">Search</button>
    {% if q %}
      <a href="/admin/media" class="btn btn-ghost btn-sm">Clear</a>
    {% endif %}
  </form>
  <span class="media-count">{{ total }} file{{ 's' if total != 1 else '' }} total{% if q %} · showing {{ items | length }}{% endif %}</span>
</div>

<!-- ── Grid ──────────────────────────────────────────────────────── -->
{% if items %}
<div class="media-grid" id="media-grid">
  {% for item in items %}
  <div class="media-card" data-id="{{ item.id }}">
    <img class="media-thumb"
         src="{{ media_thumbnail(item) }}"
         alt="{{ item.alt_text or item.original_name }}"
         loading="lazy">
    <div class="media-card-overlay">
      <a href="/admin/media/{{ item.id }}/edit">
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
             stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
          <path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"/>
          <path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"/>
        </svg>
        Edit
      </a>
      <form method="post" action="/admin/media/{{ item.id }}/delete"
            onsubmit="return confirm('Delete \'{{ item.title or item.original_name }}\'? This cannot be undone.')">
        <button type="submit">
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
               stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
            <polyline points="3 6 5 6 21 6"/>
            <path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a1 1 0 0 1 1-1h4a1 1 0 0 1 1 1v2"/>
          </svg>
          Delete
        </button>
      </form>
    </div>
    <div class="media-card-body">
      <p class="media-card-name" title="{{ item.title or item.original_name }}">
        {{ item.title or item.original_name }}
      </p>
      <p class="media-card-meta">
        {{ fmt_bytes(item.file_size) }} &middot;
        {{ item.uploaded_at.strftime('%d %b %Y') if item.uploaded_at else '—' }}
      </p>
    </div>
  </div>
  {% endfor %}
</div>
{% else %}
<div class="media-empty">
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none"
       stroke="currentColor" stroke-width="1.2" stroke-linecap="round" stroke-linejoin="round">
    <rect x="3" y="3" width="18" height="18" rx="2" ry="2"/>
    <circle cx="8.5" cy="8.5" r="1.5"/>
    <polyline points="21 15 16 10 5 21"/>
  </svg>
  {% if q %}
    <p>No files match "<strong>{{ q }}</strong>". <a href="/admin/media">Clear search →</a></p>
  {% else %}
    <p>No media uploaded yet. Drag images into the drop-zone above to get started.</p>
  {% endif %}
</div>
{% endif %}

{% endblock %}

{% block scripts %}
<script>
(function () {
  // ── Upload helper ─────────────────────────────────────────────
  async function uploadFiles(fileList) {
    const list = document.getElementById('dz-progress-list');

    for (const file of fileList) {
      const li = document.createElement('li');
      li.className = 'dz-prog-item';
      li.innerHTML = `
        <span style="max-width:160px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${file.name}</span>
        <div class="dz-prog-bar-wrap"><div class="dz-prog-bar" id="pb-${file.name.replace(/\W/g,'_')}"></div></div>
        <span id="st-${file.name.replace(/\W/g,'_')}">0%</span>
      `;
      list.appendChild(li);

      const formData = new FormData();
      formData.append('files', file);

      const barId = `pb-${file.name.replace(/\W/g,'_')}`;
      const stId  = `st-${file.name.replace(/\W/g,'_')}`;

      await new Promise((resolve) => {
        const xhr = new XMLHttpRequest();
        xhr.open('POST', '/admin/media/upload');
        xhr.upload.onprogress = (e) => {
          if (e.lengthComputable) {
            const pct = Math.round(e.loaded / e.total * 100);
            document.getElementById(barId).style.width = pct + '%';
            document.getElementById(stId).textContent  = pct + '%';
          }
        };
        xhr.onload = () => {
          document.getElementById(barId).style.width = '100%';
          document.getElementById(stId).textContent  = '✓';
          resolve();
        };
        xhr.onerror = () => {
          document.getElementById(stId).textContent = '✗ Error';
          resolve();
        };
        xhr.send(formData);
      });
    }

    // Reload page after all uploads
    setTimeout(() => { window.location.href = '/admin/media?msg=Upload+complete&msg_type=success'; }, 500);
  }

  // ── Drop-zone wiring ─────────────────────────────────────────
  const dz    = document.getElementById('dropzone');
  const dzIn  = document.getElementById('dz-input');
  const hIn   = document.getElementById('header-upload');

  dz.addEventListener('dragover',  (e) => { e.preventDefault(); dz.classList.add('drag-over'); });
  dz.addEventListener('dragleave', ()  => dz.classList.remove('drag-over'));
  dz.addEventListener('drop', (e) => {
    e.preventDefault();
    dz.classList.remove('drag-over');
    if (e.dataTransfer.files.length) uploadFiles(e.dataTransfer.files);
  });

  dzIn.addEventListener('change', () => { if (dzIn.files.length) uploadFiles(dzIn.files); });
  if (hIn) hIn.addEventListener('change', () => { if (hIn.files.length) uploadFiles(hIn.files); });
})();
</script>
{% endblock %}
